name: "ðŸ“Š Deployment Landscape - february-greeting-app"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: string
      image_tag:
        description: 'Image tag deployed'
        required: true
        type: string
      deployment_status:
        description: 'Deployment status'
        required: true
        type: string
      timestamp:
        description: 'Deployment timestamp'
        required: false
        type: string

env:
  TENANT: opsera
  APP_NAME: february-greeting-app
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write

jobs:
  generate-landscape:
    name: "ðŸ“Š Generate Deployment Landscape"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Kubeconfig (Spoke)
        run: |
          aws eks update-kubeconfig --name $SPOKE_CLUSTER --region $AWS_REGION --alias spoke
          kubectl config use-context spoke

      - name: Collect Deployment Data
        id: collect
        run: |
          ENV="${{ inputs.environment }}"
          NS="${TENANT}-${APP_NAME}-${ENV}"

          # Collect pod information
          PODS=$(kubectl --context spoke get pods -n $NS -o json | jq -c '.items')
          POD_COUNT=$(echo "$PODS" | jq 'length')

          # Collect service information
          SERVICES=$(kubectl --context spoke get svc -n $NS -o json | jq -c '.items')

          # Collect ingress information
          INGRESS=$(kubectl --context spoke get ingress -n $NS -o json 2>/dev/null | jq -c '.items' || echo '[]')

          # Export for next step
          echo "pod_count=$POD_COUNT" >> $GITHUB_OUTPUT
          echo "pods<<EOF" >> $GITHUB_OUTPUT
          echo "$PODS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate LANDSCAPE.md
        run: |
          ENV="${{ inputs.environment }}"
          NS="${TENANT}-${APP_NAME}-${ENV}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          cat > .opsera-${APP_NAME}/LANDSCAPE.md <<'EOF'
          # Deployment Landscape - february-greeting-app

          **Last Updated:** $TIMESTAMP

          ## Overview
          - **Application:** february-greeting-app
          - **Environment:** ${{ inputs.environment }}
          - **Namespace:** $NS
          - **Image Tag:** ${{ inputs.image_tag }}
          - **Deployment Status:** ${{ inputs.deployment_status }}
          - **Deployed At:** ${{ inputs.timestamp }}

          ## Application Metadata
          - **Tenant:** opsera
          - **Spoke Cluster:** opsera-usw2-np
          - **Region:** us-west-2
          - **Domain:** agent.opsera.dev

          ## Deployment Status
          - **Status:** âœ… ${{ inputs.deployment_status }}
          - **Pod Count:** ${{ steps.collect.outputs.pod_count }}
          - **Image:** ${{ inputs.image_tag }}

          ## Pods
          $(kubectl --context spoke get pods -n $NS -o wide 2>/dev/null || echo "No pods found")

          ## Services
          $(kubectl --context spoke get svc -n $NS -o wide 2>/dev/null || echo "No services found")

          ## Ingress
          $(kubectl --context spoke get ingress -n $NS 2>/dev/null || echo "No ingress found")

          ## Recent Events
          $(kubectl --context spoke get events -n $NS --sort-by='.lastTimestamp' | tail -10)

          ---
          *Generated by Opsera Code-to-Cloud Enterprise v0.930*
          EOF

          echo "âœ… LANDSCAPE.md generated"

      - name: Update Deployments Manifest (RULE 179)
        run: |
          MANIFEST_FILE=".opsera-${APP_NAME}/deployments-manifest.json"

          # Initialize if doesn't exist
          if [ ! -f "$MANIFEST_FILE" ]; then
            echo "[]" > "$MANIFEST_FILE"
          fi

          # Build new entry
          NEW_ENTRY=$(cat <<JSON
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "environment": "${{ inputs.environment }}",
            "imageTag": "${{ inputs.image_tag }}",
            "status": "${{ inputs.deployment_status }}",
            "commitSha": "${{ github.sha }}",
            "commitAuthor": "${{ github.actor }}",
            "deployedBy": "github-actions",
            "namespace": "${TENANT}-${APP_NAME}-${{ inputs.environment }}"
          }
          JSON
          )

          # Prepend new entry and cap at 50
          jq --argjson new_entry "$NEW_ENTRY" '. = [$new_entry] + . | .[0:50]' "$MANIFEST_FILE" > temp.json
          mv temp.json "$MANIFEST_FILE"

          echo "âœ… Deployments manifest updated"

      - name: Commit and Push Landscape
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stash, pull, pop pattern (RULE 172)
          git add .opsera-${APP_NAME}/LANDSCAPE.md .opsera-${APP_NAME}/deployments-manifest.json
          git stash
          git pull --rebase origin main || true
          git stash pop || true
          git add .opsera-${APP_NAME}/LANDSCAPE.md .opsera-${APP_NAME}/deployments-manifest.json

          git commit -m "chore(landscape): update deployment landscape for ${{ inputs.environment }} [skip ci]" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"

          echo "âœ… Landscape committed and pushed"

      - name: Display Summary
        run: |
          echo "## ðŸ“Š Deployment Landscape Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ inputs.deployment_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pod Count:** ${{ steps.collect.outputs.pod_count }}" >> $GITHUB_STEP_SUMMARY
